#!/usr/bin/env Rscript
# generate a cactus plot (png and pdf) from CVS files
# USAGE: mkCactus runs [nproblems] [subtitle]
# where runs is a filename that contains a list of CSV filenames which are generated by sat-benchmark
library("ggplot2")
version = "0.11.0"

solved = 0

getData = function (t, p, cut) {
    df1 <- read.csv(as.character(t[[1]]), header=T, sep=",", comment="#")
    if (nrow(df1) == 0) { return(NULL) }
    df2 <- data.frame(solver=df1[["solver"]],
                      num=df1[["num"]],
                      target=df1[["target"]],
                      time=df1[["time"]])
    if (ncol(df1) == 5) {
        df2[["valid"]] <- df1[["valid"]]
    } else {
        df2[["valid"]] <- numeric(nrow(df2))
    }
    if (0 < cut) {
        df2 <- df2[1:min(nrow(df2),cut),]
    }
    df2 <- df2[order(df2[["time"]]),]         	# sort by time
    if (p && t[[2]] != "") { df2[["solver"]] = sub("^ +", "", as.character(t[[2]])) }
    df2[["num"]] <- 1:nrow(df2)            	# reassign rownumbers
    thr <- max(df2[["time"]])
    solved <<- max(solved, nrow(subset(df2,  time < 0.8 * thr)))
    df2
}

graph = function (d, subt, cut) {
    g <- ggplot(d, aes(num, time, color=solver, size=solver, alpha=solver))
    g <- g + geom_point(size=0.5)
    g <- g + geom_line(data=d)
    g <- g + geom_point(data=subset(d, valid==3),size=2,shape=4)
    g <- g + scale_size_manual(values=rep(0.6, times=nrow(d)))
    g <- g + scale_alpha_manual(values=rep(1.0, times=nrow(d)))
    # g <- g + scale_size_manual(values=c(0.7,0.7,0.7,0.7,0.3,0.3,0.3))  -- by aes(size=solver)
    # g <- g + scale_alpha_manual(values=c(1.0,1.0,1.0,1.0,0.5,0.5,0.5)) -- by aes(alpha=solver)
    maxx <- (3 * solved + cut) / 4
    if (cut < 0.7 * solved) {
        g <- g + theme(legend.position = c(0.05,0.95), legend.justification = c(0,1))
    } else {
        g <- g + theme(legend.position = c(0.95,0.05), legend.justification = c(1,0))
    }
    g <- g + scale_y_continuous(limits=c(0,max(d$time)), breaks=seq(0,max(d$time),100), expand=c(0.01,4))
    # g <- g + scale_y_continuous(limits=c(0,410) ,breaks=seq(0,410,100))
    if (0.75 * cut < solved) {
        g <- g + scale_x_continuous(limits=c(0,maxx), breaks=seq(00,maxx,10), expand=c(0,2))
        g <- g + annotate("text", x=100, y=50,
                          label=paste(format(as.POSIXlt(Sys.time()), "%Y-%m-%dT%H:%M:%S"), " ", "drawn with mkCactusL.R (ver. ", version, ")", sep=""),
                          color="darkgray", size=2.6)
    } else {
        g <- g + scale_x_continuous(limits=c(0,maxx), breaks=seq(00,maxx,10), expand=c(0,2))
        g <- g + annotate("text", x=70, y=20,
                          label=paste(format(as.POSIXlt(Sys.time()), "%Y-%m-%dT%H:%M:%S"), " ", "drawn with mkCactusL.R (ver. ", version, ")", sep=""),
                          color="darkgray", size=2.6)
    }
    g <- g + labs(title="Cactus plot on SAT-Race 2018 Main track", subtitle=subt,
                  x=if (0 < cut) paste("#solved out of ", cut, sep="") else "#solved", y="execution time [sec]")
    print(g)
}

(function() {
    merged <- list()
    args <- commandArgs(trailingOnly=TRUE)
    ts <-format(as.POSIXlt(Sys.time()), "%Y-%m-%dT%H:%M:%S")

    if (1 <= length(args)){
        exps <- args[1]
        name <- gsub("\\.[^.]+$", "", exps)
        targetPDF <- paste("CactusL-", name, ".pdf", sep="")
    } else {
        exps <- "runs"
        name <- "runs"
        targetPDF <- "CactusL-SC17main.pdf"
    }
    cut <- -1
    if (2 <= length(args)) { cut <- as.integer(args[2] ) }
    subt <- paste(exps, " -- ", ts, " drawn with mkCactusL.R (ver. ", version, ")", sep="")
    #subt <- "- timeout: 2000 sec(3 jobs in parallel), CPU: Intel Core i7-6700@3.4GHz, Mem: 8GB,OS Linux 4.14(ArchLinux)" # rio
    #subt <- "- timeout: 1600 sec. (3 jobs in parallel), CPU: Intel(R) Core(TM) i7-3930K CPU @ 3.20GHz, Mem: 16GB,OS Linux 4.14(NixOS)" # smithi 
    #subt <- "- timeout: 500 sec(3 jobs in parallel), CPU: Intel Celeron N2830@2.16GHz, Mem: 8GB,OS Linux 4.14(NixOS 18.03pre)" # yadoku/tamao
    if (3 <= length(args) && args[3] != "") { subt <- args[3] }
    runs <- read.csv(exps, comment="#", sep=",", header=F)
    withTag <- 1 < ncol(runs)
    for (i in seq(nrow(runs))) { merged = rbind(merged, getData(runs[i,], withTag, cut)); }

    cairo_pdf(filename=targetPDF, width=10, height=6, antialias="subpixel", onefile=TRUE)
    graph(merged, subt, cut)
    ggsave(filename=targetPDF, width=10, height=6, scale=1.0, dpi=400)
})()
